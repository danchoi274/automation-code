Sub ACH_Format()

Dim lRow, lRowNew As Long
Dim nextDate
Dim saveNextDate
Dim olApp, olEmail, recipient
Dim dic As Dictionary

Set dic = CreateObject("Scripting.Dictionary")
Set olApp = CreateObject("outlook.application")
Set olEmail = olApp.CreateItem(0)
Set rec = CreateObject("Scripting.Dictionary")

nextDate = Application.WorkDay(Date, 1)
saveNextDate = Format(nextDate, "mmddyy")

'***after pasting ACH Debit info***

lRow = Cells.Find(What:="*", _
                After:=Range("A1"), _
                LookAt:=xlPart, _
                LookIn:=xlFormulas, _
                SearchOrder:=xlByRows, _
                SearchDirection:=xlPrevious, _
                MatchCase:=False).Row
                
'remove column 2 and format headers

Application.ScreenUpdating = False

Range("B:B").Delete
Cells(1, 1).Value = "EOR"
Cells(1, 2).Value = "Added By User"
Cells(1, 3).Value = "Client Name"
Cells(1, 4).Value = "Client ID"
Cells(1, 5).Value = "Invoice Number"
Cells(1, 6).Value = "Document Type"
Cells(1, 7).Value = "Invoice Credit Type"
Cells(1, 8).Value = "Terms"
Cells(1, 9).Value = "JDE Number"
Cells(1, 10).Value = "Invoice Status"
Cells(1, 11).Value = "Invoice Date"
Cells(1, 12).Value = "Due Date"
Cells(1, 13).Value = "Check Date"
Cells(1, 14).Value = "Payroll Release Date"
Cells(1, 15).Value = "Gross Amount"
Cells(1, 16).Value = "Open Amount"
Cells(1, 17).Value = "Invoice Comment"
Cells(1, 18).Value = "Bank Transit"
Cells(1, 19).Value = "Customer Bank Account"
Cells(1, 20).Value = "Bank Record Type"
Cells(1, 21).Value = "Pay Code Flag"
Cells(1, 22).Value = "Pay Code Amount"
Cells(1, 23).Value = "AC$SPI"
Cells(1, 24).Value = "AC$TOI"
Cells(1, 1).EntireRow.Font.Bold = True

'add and rename sheets

Sheets("Sheet1").Name = "All"
Sheets.Add(After:=Sheets("All")).Name = "CT"
Sheets.Add(After:=Sheets("CT")).Name = "MA"
Sheets.Add(After:=Sheets("MA")).Name = "All to ACH"

'transfer information from All to All to ACH

Sheets("All").Cells.Copy
Sheets("All to ACH").Paste

'format Gross Amount and Open Amount in All to ACH

Worksheets("All to ACH").Activate

Columns("O:P").Select
Selection.NumberFormat = "#,##0.00_);[Red](#,##0.00)"

'Criteria for row deletion:
'NO BANK ACCOUNT
'"DO NOT ACH"

For x = lRow To 2 Step -1
    If Worksheets("All to ACH").Cells(x, "R").Value Like "DO NOT ACH" _
    Or Len(Worksheets("All to ACH").Cells(x, "R").Value) = 0 Then
    Worksheets("All to ACH").Cells(x, "R").EntireRow.Delete
    End If
    
'Highlight outliers "RB" or "RU"

    If Worksheets("All to ACH").Cells(x, "F").Value = "RB" Or Worksheets("All to ACH").Cells(x, "F").Value = "RU" Then
    Worksheets("All to ACH").Cells(x, "F").Interior.Color = RGB(0, 150, 0)
    End If
Next x

'Highlight if client wants ACH from a specific account

For v = 2 To lRow
    If Cells(v, "Q").Value Like "*ACH*" Or Cells(v, "Q").Value Like "*ACCT*" Then
    Cells(v, "Q").Interior.Color = RGB(255, 255, 0)
    Cells(v, "C").Interior.Color = RGB(255, 255, 0)
        If (InStr(Cells(v, "Q").Value, Right(Cells(v, "S").Value, 3))) <> 0 Then
        Cells(v, "Q").Interior.Color = RGB(255, 192, 0)
        End If
    End If
Next v
    
'Delete rows with empty check date and positive open amount less than $500k
'*NOTE: Imported data sees "empty" cell as blank NOT empty* hence using len(trim)

For y = lRow To 2 Step -1
    If Len(Trim(Cells(y, "M").Value)) = 0 And Cells(y, "P").Value > 0 And Cells(y, "P").Value < 500000 Then
    Cells(y, "M").EntireRow.Delete
    End If
Next y

'Autofit Columns

Columns("C").AutoFit
Columns("O:Q").AutoFit

'Paste into CT and MA

Sheets("All to ACH").Cells.Copy
Sheets("CT").Paste
Sheets("MA").Paste

'Delete relevant EOR from CT and MA

For t = lRow To 2 Step -1
    If Worksheets("CT").Cells(t, 1).Value Like "A" Or Worksheets("CT").Cells(t, 1).Value Like "T" Then
    Worksheets("CT").Cells(t, 1).EntireRow.Delete
    End If
    If Worksheets("MA").Cells(t, 1).Value Like "D" Or Worksheets("MA").Cells(t, 1).Value Like "S" Then
    Worksheets("MA").Cells(t, 1).EntireRow.Delete
    End If
Next t

'Sort by User and Client Name for CT

tRange = "A1:" & "Y" & lRow

Worksheets("CT").Sort.SortFields.Clear
Worksheets("CT").Sort.SortFields.Add2 key:=Range("B:B"), _
    SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
Worksheets("CT").Sort.SortFields.Add2 key:=Range("C:C"), _
    SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
With Worksheets("CT").Sort
    .SetRange Range(tRange)
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
End With

'Subtotal CT by User, on Sum, by Open Amount,
'replacing current subtotals, page break between groups, grand total

Worksheets("CT").Activate
ActiveSheet.UsedRange.Select
Selection.Subtotal _
    GroupBy:=2, _
    Function:=xlSum, _
    TotalList:=Array(16), _
    Replace:=True, _
    PageBreaks:=True, _
    SummaryBelowData:=True

'Sort MA

Worksheets("MA").Sort.SortFields.Clear
Worksheets("MA").Sort.SortFields.Add2 key:=Range("B:B"), _
    SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
Worksheets("MA").Sort.SortFields.Add2 key:=Range("C:C"), _
    SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
With Worksheets("MA").Sort
    .SetRange Range(tRange)
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
End With

'Subtotal MA

Worksheets("MA").Activate
ActiveSheet.UsedRange.Select
Selection.Subtotal _
    GroupBy:=2, _
    Function:=xlSum, _
    TotalList:=Array(16), _
    Replace:=True, _
    PageBreaks:=True, _
    SummaryBelowData:=True
    
'Save workbook

ActiveWorkbook.SaveAs Filename:="J:\Accounts Receivables\ACH Debit\2020\ACH_" & saveNextDate & "-toACH", _
FileFormat:=xlOpenXMLWorkbookMacroEnabled
    
'Delete credits in "All to ACH" sheet

Worksheets("All to ACH").Activate
For k = lRow To 2 Step -1
    If Cells(k, "P").Value < 0 Then
    Cells(k, "M").EntireRow.Delete
    End If
Next k

Application.ScreenUpdating = True

'Call ACH_Send

'End Sub

'Sub ACH_Send()

'Dim olApp, olEmail, recipients, lRowNew
'Dim dic As Dictionary

'Set dic = CreateObject("Scripting.Dictionary")
'Set olApp = CreateObject("outlook.application")
'Set olEmail = olApp.CreateItem(0)
'Set rec = CreateObject("Scripting.Dictionary")

'update the email contact name here
'left side is what is in the excel file
'right side is the email address sans domain

rec.Add "BDELGADO", "briana.delgado"
rec.Add "CBRAUER", "cbrauer"
rec.Add "DWILLIAM", "dwilliamson"
rec.Add "GGEIGER", "ggeiger"
rec.Add "JDUNN", "jdunn"
rec.Add "JWORMER", "jwormer"
rec.Add "AACHAY", "aachay"
rec.Add "DCLAY", "dclay"
rec.Add "HGARGANE", "hgarganera"
rec.Add "IROSALES", "irosales"
rec.Add "JMACROHO", "lmacrohon"
rec.Add "JRASCON", "jrascon"
rec.Add "JWOJTANO", "jwojtanowski"
rec.Add "MMURPHY", "mmurphy"
rec.Add "RGONZALE", "rgonzalez"
rec.Add "RTIWARIE", "rtiwarie"
rec.Add "TABITHAM", "tabitham"
rec.Add "LMEEKER", "lmeeker"

lRowNew = Sheets("All to ACH").Cells.Find(What:="*", _
                    After:=Range("A1"), _
                    LookAt:=xlPart, _
                    LookIn:=xlFormulas, _
                    SearchOrder:=xlByRows, _
                    SearchDirection:=xlPrevious, _
                    MatchCase:=False).Row

For x = 2 To lRowNew
If dic.Exists(Sheets("All to ACH").Cells(x, "B").Value) Then
    Else
    dic.Add Sheets("All to ACH").Cells(x, "B").Value, x
End If
Next x

With olEmail
    olEmail.cc = "anguyen@theteamcompanies.com;" & _
            "msermonia@theteamcompanies.com;" & _
            "dclarino@theteamcompanies.com;" & _
            "ggomez@theteamcompanies.com;" & _
            "hleasiolagi@theteamcompanies.com;" & _
            "dpaez@theteamcompanies.com;" & _
            "dchoi@theteamcompanies.com;"
        .Subject = "ACH FOR PROCESSING " & FormatDateTime(Date, vbShortDate)
        .htmlbody = ("***Please do not reply all when responding***<br><br>" & _
        "<font color=""red""><b>All invoices without a check date have been removed from the ACH.</font></b><br><br>" & _
        "<u>Please see attached and advise on the <b>HOLDS and CREDITS (including any credits to be netted).</b></u><br><br>" & _
        "<font color=""#2E75B6"">We will proceed with processing the ACH which includes adjusting all of the advised holds. " & _
        "As we are generally working with a high volume, the goal is to avoid ACH's of incorrect amounts, incorrect bank accounts, and or unauthorized transactions. " & vbCrLf & vbCrLf & _
        "When the invoice is ready to ACH, it will be initiated the following business day.<br><br>" & _
        "<u><b>Any items not requested for hold will be ACH'd.</u></b></font><br><br>" & _
        "Thank you!")
        .Display
        '.attachments.Add ActiveWorkbook.FullName
        .attachments.Add ("J:\Accounts Receivables\ACH Debit\2020\ACH_" & saveNextDate & "-toACH.xlsm")
    For Each dkey In dic.Keys
        If rec.Exists(dkey) Then
        olEmail.recipients.Add (rec.Item(dkey) & "@theteamcompanies.com")
        Else
        MsgBox (dkey & " does not exist in the email list")
        End If
    Next dkey
End With

Sheets("All to ACH").Cells(lRowNew + 1, "P").Value = WorksheetFunction.Sum(Range("P1:P" & lRowNew))

Set olEmail = Nothing
Set olApp = Nothing

End Sub
